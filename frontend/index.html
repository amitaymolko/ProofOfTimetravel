<html>
    <script type="text/javascript" src="web3.min.js"></script>

    <script>
        var contractAddress = "0xdda6327139485221633a1fcd65f4ac932e60a2e1"
        var ABI = [{ "constant": true, "inputs": [{ "name": "", "type": "uint256" }], "name": "predictions", "outputs": [{ "name": "predictor", "type": "address" }, { "name": "predictedBlock", "type": "uint256" }, { "name": "predictedHash", "type": "bytes32" }, { "name": "creationBlock", "type": "uint256" }, { "name": "won", "type": "bool" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "", "type": "uint256" }], "name": "winningPredictionIndexes", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "inputs": [], "payable": false, "stateMutability": "nonpayable", "type": "constructor" }, { "payable": true, "stateMutability": "payable", "type": "fallback" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "investor", "type": "address" }, { "indexed": false, "name": "value", "type": "uint256" }, { "indexed": false, "name": "blockNumber", "type": "uint256" }], "name": "InvestmentEvent", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "predictor", "type": "address" }, { "indexed": false, "name": "blockNumber", "type": "uint256" }, { "indexed": false, "name": "predictionIndex", "type": "uint256" }], "name": "PredictionEvent", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "predictor", "type": "address" }, { "indexed": false, "name": "blockNumber", "type": "uint256" }, { "indexed": false, "name": "predictionIndex", "type": "uint256" }], "name": "FailedProofOfTimetravelEvent", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "predictor", "type": "address" }, { "indexed": false, "name": "blockNumber", "type": "uint256" }, { "indexed": false, "name": "predictionIndex", "type": "uint256" }], "name": "ProofOfTimetravelEvent", "type": "event" }, { "constant": false, "inputs": [{ "name": "_block", "type": "uint256" }, { "name": "_hash", "type": "bytes32" }], "name": "makePrediction", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_index", "type": "uint256" }], "name": "claimReward", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [{ "name": "_address", "type": "address" }], "name": "getPendingPredictionByAddress", "outputs": [{ "name": "", "type": "address" }, { "name": "", "type": "uint256" }, { "name": "", "type": "bytes32" }, { "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "_address", "type": "address" }], "name": "getPendingPredictionIndexByAddress", "outputs": [{ "name": "", "type": "int256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "_index", "type": "uint256" }], "name": "getPrediction", "outputs": [{ "name": "", "type": "address" }, { "name": "", "type": "uint256" }, { "name": "", "type": "bytes32" }, { "name": "", "type": "uint256" }, { "name": "", "type": "bool" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "getPredictionsLength", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "_index", "type": "uint256" }], "name": "getWinningPrediction", "outputs": [{ "name": "", "type": "address" }, { "name": "", "type": "uint256" }, { "name": "", "type": "bytes32" }, { "name": "", "type": "uint256" }, { "name": "", "type": "bool" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "getWinningPredictionsLength", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "timeTravelProven", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "view", "type": "function" }]
        var contract 
        var predictions = [];
       
        var onLoad = function() {

            if (typeof window.web3 !== 'undefined') {
                console.log('web3', window.web3.currentProvider)
                web3 = new Web3(window.web3.currentProvider);
            } else {
                console.log('web3', 'new')
                // set the provider you want from Web3.providers
                web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));
            }

            if (!contract) {
                contract = web3.eth.contract(ABI).at(contractAddress)
                web3.eth.defaultAccount = web3.eth.accounts[0]
            }

            var addressSpan = document.getElementById("addressSpan")
            addressSpan.innerHTML = contractAddress

            loadBalance()
        }

        var CreatePredictionObject = function(value, index) {
            return {
                predictor: value[0],
                predictedBlock: value[1].toNumber(),
                predictedHash: value[2],
                creationBlock: value[3].toNumber(),
                won: value[4],
                index: index
            }
        }

        var loadPrediction = function(index) {
            contract.getPrediction(index, function (err, value) {
                if (!err) {
                    console.log('loadPrediction index', index)
                    
                    predictions.push(CreatePredictionObject(value, index))
                    insertRow(predictions.length - 1)
                } else {
                    console.log('getPrediction err', index, err);
                }
            })
        }

        var loadBalance = function() {
            web3.eth.getBalance(contract.address, function(err, value) {
                var balance = web3.fromWei(value.toNumber(), 'ether')
                var balanceSpan = document.getElementById("balanceSpan")
                balanceSpan.innerHTML = balance + ' ETH';
            })

            contract.getPredictionsLength(function(err, value) {
                if (err) {
                    console.log('err', err);
                } else {
                    console.log('value', value);
                    var length = value.toNumber();
                    for (var index = Math.max(0, length - 100); index < length; index++) {
                        console.log('index', index)
                        loadPrediction(index)
                       
                    }
                }
            })

            contract.timeTravelProven(function (err, value) {
                if (err) {
                    console.log('err', err)
                } else {
                    var timeTravelSpan = document.getElementById("timeTravelSpan")
                    timeTravelSpan.innerHTML = value ? 'YES!' : 'Not yet...'
                }
            })
        }

        var makePrediction = function() {
            var blockNumber = document.getElementById("blockInput").value;
            var blockHash = document.getElementById("hashInput").value;
            console.log('blockNumber', blockNumber)
            console.log('blockHash', blockHash)
            
            contract.makePrediction(parseInt(blockNumber), blockHash,  function (err, value) {
                console.log('err', err);
                if (!err) {
                    console.log('value', value);
                }
            })
        }

        var claimReward = function() {
            var index = document.getElementById("indexInput").value;
            console.log('index', index)
            
            contract.claimReward(parseInt(index),  function (err, value) {
                console.log('err', err);
                if (!err) {
                    console.log('value', value);
                }
            })
        }

        var insertRow = function (index) {
            var predictionsTable = document.getElementById("predictionsTable");

            // for (let index = 0; index < predictions.length; index++) {
                const prediction = predictions[index];
                var row = predictionsTable.insertRow(prediction.index + 1);

                // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var cell3 = row.insertCell(2);
                var cell4 = row.insertCell(3);
                var cell5 = row.insertCell(4);
                var cell6 = row.insertCell(5);

                // Add some text to the new cells:
                cell1.innerHTML = prediction.index;
                cell2.innerHTML = prediction.predictor;
                cell3.innerHTML = prediction.predictedBlock;
                cell4.innerHTML = prediction.predictedHash;
                cell5.innerHTML = prediction.creationBlock;
                cell6.innerHTML = prediction.won;
            // }
        }
    </script>

    <body onload="onLoad()">
        Time travel proven: <span id="timeTravelSpan"></span>
        <br />
        Current pot: <span id="balanceSpan"> </span> 
        <br />
        Donate to Timetravelers: <span id="addressSpan"></span>
        <br />

        Make Prediction:
        <input id="blockInput" type="text" placeholder="block number"></input>
        <input id="hashInput" type="text"  placeholder="block hash"></input>
        <button onclick="makePrediction()">Make Prediction</button>
        <br />
        Claim Reward:
        <input id="indexInput" type="text" placeholder="Prediction Index"></input>
        <button onclick="claimReward()">Claim</button>

        <table id="predictionsTable">
            <thead>
                <th>Index</th>
                <th>Predictor</th>
                <th>Predicted Block</th>
                <th>Predicted Hash</th>
                <th>Creation Block</th>
                <th>Won</th>
            </thead>
        </table>
    </body>

</html>